# Raspberry Pi Pico Build & Program Tool

## Overview

This tool makes it easy to build and program Raspberry Pi Pico devices without dealing with complex CMake commands directly. It simplifies the process of building your code, flashing it to Pico devices, and even supports production workflows where you need to assign and track unique serial numbers for multiple devices.

## Requirements

- Python 3.6 or newer
- Raspberry Pi Pico SDK (installed to `~/.pico-sdk`)
- ARM GCC Toolchain 
- CMake
- Ninja build system

## Quick Start

### Basic Usage

```
# Build your project
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project

# Build and flash to a connected Pico
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --all

# Clean the build directory and rebuild
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --clean --rebuild
```

### Basic Commands

- `--clean`: Clean the build directory
- `--configure`: Just run the CMake configuration step
- `--build`: Just build the project (without configuring)
- `--rebuild`: Clean, configure, and build
- `--deploy`: Flash the firmware to a connected Pico
- `--all`: Configure, build, and flash to Pico

## Advanced Usage

### Flashing Pre-built UF2 Files

If you have a pre-built UF2 file, you can flash it directly:

```
py -3 FlashApp/RP_flasher.py --flash your_firmware.uf2
```

If you get a warning about the device already having firmware, you can force the operation:

```
py -3 FlashApp/RP_flasher.py --flash your_firmware.uf2 --force
```

### Production Programming

The tool supports a production workflow where each device gets a unique serial number. This is useful when you're making multiple devices and need to keep track of them.

#### Setting Up Serial Numbers

1. Create a CSV file (e.g., `serial_numbers.csv`) with your serial numbers:

```csv
serial_number,date_programmed,firmware_version,programmed_by,batch_id,notes
PICO-001,2023-10-15,0.9.0,developer,BATCH0001,Initial test unit
PICO-002,2023-10-15,0.9.0,developer,BATCH0001,Development unit
PICO-003,,,,BATCH0002,Available for use
PICO-004,,,,BATCH0002,Available for use
```

2. Create a template file (e.g., `serial_number.h.template`) that will be used to generate a header with the serial number:

```c
#ifndef SERIAL_NUMBER_H
#define SERIAL_NUMBER_H

// This file is automatically generated - do not edit manually

#define SERIAL_NUMBER "SERIAL_NUMBER_PLACEHOLDER"

#endif // SERIAL_NUMBER_H
```

#### Production Programming Commands

- **Program with serial numbers**:
  ```
  py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv
  ```

- **List all devices and their status**:
  ```
  py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --list-devices
  ```

- **Check which serial number is next**:
  ```
  py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --next-serial
  ```

- **Set firmware version and programmer name**:
  ```
  py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --firmware-version 1.1.0 --programmed-by "John"
  ```

### Complete Production Workflow

For programming multiple devices in a production setting:

1. **Preparation**:
   - Ensure your code includes `"serial_number.h"` and uses the `SERIAL_NUMBER` constant
   - Set up your `serial_numbers.csv` with all device serial numbers
   - Create your `serial_number.h.template` file with the `SERIAL_NUMBER_PLACEHOLDER`

2. **Programming Process**:
   - Start by checking available serial numbers:
     ```
     py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --list-devices
     ```
   
   - For each device:
     1. Connect a Pico in BOOTSEL mode
     2. Run the production command:
        ```
        py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --firmware-version X.Y.Z --programmed-by "Name"
        ```
     3. Verify successful programming
     4. Disconnect the device and connect the next one
     
   - After programming all devices, verify the CSV records:
     ```
     py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --list-devices
     ```

3. **Verification Testing**:
   - Connect each programmed device to verify it boots properly
   - Check that each device reports the correct serial number through its interface

## How It Works

### Basic Build Process

1. **Configuration**: The tool runs CMake to set up your build
2. **Building**: Ninja is used to compile your code
3. **Deployment**: The compiled UF2 file is copied to your Pico when in BOOTSEL mode

### Production Process

1. **Serial Number Management**: The tool reads from your CSV file to find the next available serial number
2. **Header Generation**: Creates a C header file with your unique serial number
3. **Build Process**: Compiles your code with the serial number embedded
4. **Programming**: Flashes the firmware to the Pico
5. **Record Keeping**: Updates the CSV file with the date, firmware version, and who programmed it

### Implementing Serial Numbers in Your Code

The tool generates a `serial_number.h` file in your project directory that defines a `SERIAL_NUMBER` constant. To use this in your code:

1. Add the include directive to your C files:
   ```c
   #include "serial_number.h"
   ```

2. Reference the serial number constant in your code:
   ```c
   printf("Device Serial Number: %s\n", SERIAL_NUMBER);
   ```

3. When the project builds, the correct unique serial number will be available to your code.

Example modification to a simple project:

```c
#include <stdio.h>
#include "pico/stdlib.h"
#include "serial_number.h"  // Include the generated header

int main()
{
    stdio_init_all();
    
    // Print startup message with serial number
    printf("\n\nInitializing device %s\n", SERIAL_NUMBER);
    
    while (true) {
        printf("Hello from device %s!\n", SERIAL_NUMBER);
        sleep_ms(1000);
    }
}
```

### Device Identification System

- **Embedded Serial Number**: The tool embeds the device's serial number directly in the firmware through the `serial_number.h` header file, which serves two purposes:
  1. Makes the serial number accessible to your code at runtime
  2. Allows the device to be identified later when connected in BOOTSEL mode

- **Reading Device Information**: When a programmed Pico is connected in BOOTSEL mode, the tool can:
  - Scan the device's flash memory for the `serial_number.h` file
  - Extract the unique serial number from the header file
  - Look up the device's complete history in the CSV database (programming date, firmware version, etc.)
  - Display full details about the connected device

- **Commands for Device Identification**:
  ```
  py -3 FlashApp/RP_flasher.py --identify-device
  py -3 FlashApp/RP_flasher.py --identify-device --production serial_numbers.csv
  ```

### Safety Features

- **Firmware Detection System**: The tool checks if a device might already have firmware before flashing using:
  1. First, scanning for a `serial_number.h` file to identify devices programmed with this tool
  2. As a fallback, examining the presence and content of the `INDEX.HTM` file:
     - If the standard Raspberry Pi Pico index file is found → likely a fresh device
     - If the file is missing or different → possibly already programmed
  
- **Safeguards**:
  - When potential existing firmware is detected, the tool asks for confirmation
  - You can override this check with the `--force` option when needed
  - Serial numbers are only marked as "used" in the CSV when programming succeeds completely

> Note: While the device identification system is reliable for devices programmed with this tool, the INDEX.HTM detection is a heuristic approach that is not foolproof. Use `--force` with caution to avoid overwriting important firmware.

## Configuration

The tool looks for a `flasher_config.py` file in the FlashApp directory for settings. You can also specify a different config file:

```
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --config my_other_config.py
```

Example configuration file:

```python
# Path Configuration
HOME_DIR = os.path.expanduser("~")
CMAKE_PATH = get_path(HOME_DIR, ".pico-sdk", "cmake", "v3.31.5", "bin", "cmake.exe")
C_COMPILER_PATH = get_path(HOME_DIR, ".pico-sdk", "toolchain", "14_2_Rel1", "bin", "arm-none-eabi-gcc.exe") 
CXX_COMPILER_PATH = get_path(HOME_DIR, ".pico-sdk", "toolchain", "14_2_Rel1", "bin", "arm-none-eabi-g++.exe")
NINJA_PATH = get_path(HOME_DIR, ".pico-sdk", "ninja", "v1.12.1", "ninja.exe")
```

## Troubleshooting

- **Pico not detected**: Make sure your Pico is in BOOTSEL mode (hold BOOTSEL button while connecting USB)
- **Build errors**: Check the output for compiler errors and fix them in your code
- **Python version error**: Make sure you're using Python 3.6 or newer (`py -3` on Windows)
- **Path errors**: Verify that all tool paths in your config file are correct

## Complete Command Reference

```
# Basic commands
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project     # Configure and build the project
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --clean     # Clean the build directory
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --configure  # Only run the CMake configuration step
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --build      # Only build the project
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --rebuild    # Clean, configure, and build
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --deploy     # Deploy to a connected Pico
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --all        # Configure, build, and deploy

# Advanced options
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --config my_config.py  # Use alternative config file
py -3 FlashApp/RP_flasher.py --flash latest.uf2      # Flash a pre-built UF2 file
py -3 FlashApp/RP_flasher.py --flash latest.uf2 --force # Force flash even if device seems programmed

# Production commands
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv  # Program with serial numbers
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --firmware-version 1.1.0 --programmed-by "John"
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --list-devices  # List all devices
py -3 FlashApp/RP_flasher.py --project-dir /path/to/your/project --production serial_numbers.csv --next-serial   # Show next available serial
```

## License
### Software Components
This project's software is licensed under the **GNU Affero General Public License v3.0 (AGPL-3.0)**.
See the [Software License](LICENSE-AGPL) file for details.

#### What AGPL-3.0 means:

- ✅ **You can** freely use, modify, and distribute this software
- ✅ **You can** use this project for personal, educational, or internal purposes
- ✅ **You can** contribute improvements back to this project

- ⚠️ **You must** share any modifications you make if you distribute the software
- ⚠️ **You must** release the source code if you run a modified version on a server that others interact with
- ⚠️ **You must** keep all copyright notices intact

- ❌ **You cannot** incorporate this code into proprietary software without sharing your source code
- ❌ **You cannot** use this project in a commercial product without either complying with AGPL or obtaining a different license

### Commercial & Enterprise Use

Commercial use of this project is prohibited without obtaining a separate commercial license. If you are interested in:

- Manufacturing and selling products based on these designs
- Incorporating these designs into commercial products
- Any other commercial applications

Please contact me through any of the channels listed in the [Contact](#contact) section to discuss commercial licensing arrangements. Commercial licenses are available with reasonable terms to support ongoing development.

## Contact

For questions or feedback:
- **Email:** [dvidmakesthings@gmail.com](mailto:dvidmakesthings@gmail.com)
- **GitHub:** [DvidMakesThings](https://github.com/DvidMakesThings)

## Contributing

Contributions are welcome! As this is an early-stage project, please reach out before 
making substantial changes:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/concept`)
3. Commit your changes (`git commit -m 'Add concept'`)
4. Push to the branch (`git push origin feature/concept`)
5. Open a Pull Request with a detailed description